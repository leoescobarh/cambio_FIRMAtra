<!DOCTYPE html>
<html>
<head>
  <title>Subir y modificar archivos</title>
  <style>
    .file-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .file-name {
      font-weight: bold;
      margin-right: 10px;
    }

    .file-diff {
      font-family: monospace;
      white-space: pre;
      background-color: #f6f8fa;
      padding: 10px;
    }

    .highlight {
      background-color: yellow;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/3.5.0/diff.min.js"></script>
</head>
<body>
  <input type="file" id="fileInput" multiple>
  <button onclick="processFiles()">Procesar</button>
  <div id="resultContainer" style="display: none;">
    <h3>Resultado:</h3>
    <ul id="resultList"></ul>
  </div>

  <script>
    function processFiles() {
      var fileInput = document.getElementById('fileInput');
      var files = fileInput.files;

      var resultList = document.getElementById('resultList');
      resultList.innerHTML = '';

      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        var reader = new FileReader();
        reader.onload = createFileProcessor(file);
        reader.readAsText(file);
      }
    }

    function createFileProcessor(file) {
      return function(e) {
        var contents = e.target.result;

        // Identificar relaciones comentadas y reemplazar
        var replacedContents = contents.replace(/(\/\*.*?\*\/)?([\s\S]*?)(TRA\.COD_ESTADO_FIRMA\s*=\s*1|TRA2|TRA3)/g,
          function(match, p1, p2, p3) {
            if (p1) {
              // Si la relación está comentada, mantener el comentario
              return p1 + p2 + p3;
            } else {
              // Si la relación no está comentada, realizar el reemplazo
              return p2 + 'TRA.COD_ESTADO_FIRMA IN (1,2)';
            }
          }
        );

        // Verificar si se realizó el cambio
        var isModified = replacedContents !== contents;

        // Crear archivo de salida
        var modifiedFile = new Blob([replacedContents], { type: 'text/plain' });

        // Agregar el resultado a la lista
        var listItem = document.createElement('li');
        var fileName = document.createElement('div');
        fileName.className = 'file-name';
        fileName.innerText = file.name;
        var downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(modifiedFile);
        downloadLink.innerText = isModified ? 'Descargar resultado' : 'Sin cambios';
        downloadLink.download = file.name;
        var fileDiff = document.createElement('div');
        fileDiff.className = 'file-diff
        ';
        fileDiff.innerHTML = isModified ? diffStrings(contents, replacedContents) : 'No se realizaron cambios';
        listItem.appendChild(fileName);
        listItem.appendChild(downloadLink);
        listItem.appendChild(fileDiff);
        resultList.appendChild(listItem);
            // Mostrar el contenedor de resultados
    resultContainer.style.display = 'block';
  };
}

function diffStrings(original, modified) {
  var diff = JsDiff.diffLines(original, modified);
  var diffString = '';
  var lineCount = 0;

  diff.forEach(function(part) {
    var color = part.added ? 'green' :
      part.removed ? 'red' : 'grey';

    // Incrementar el número de línea solo para partes no grises
    if (color !== 'grey') {
      lineCount++;
    }

    var lines = part.value.split('\n');
    lines.forEach(function(line) {
      if (line.trim().match(/TRA\.COD_ESTADO_FIRMA\s*IN\s*\(1,2\)|TRA2|TRA3/)) {
        line = '<span class="highlight">' + line + '</span>';
      }

      diffString += '<span style="color: ' + color + '">' + line + '</span>\n';
    });
  });

  // Agregar números de línea si hay contenido
  if (lineCount > 0) {
    diffString = addLineNumbers(diffString, lineCount);
  }

  return diffString;
}

function addLineNumbers(text, lineCount) {
  var lines = text.split('\n');
  var lineNumberWidth = lineCount.toString().length;

  for (var i = 0; i < lines.length; i++) {
    var lineNumber = i + 1;
    var padding = ' '.repeat(lineNumberWidth - lineNumber.toString().length);
    lines[i] = '<span style="display: inline-block; width: 20px; text-align: right;">' + padding + lineNumber + ':</span> ' + lines[i];
  }

  return lines.join('\n');
}
  </script>
</body>
</html>


